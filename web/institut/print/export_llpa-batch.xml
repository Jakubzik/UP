<%@ page contentType="application/vnd.ms-excel" errorPage="../json/error.jsp" session="true" import="de.shj.UP.transcript.Fachnote,java.math.BigDecimal,de.shj.UP.data.shjCore,de.shj.UP.HTML.HtmlDate,java.sql.ResultSet" %><jsp:useBean id="user" scope="session" class="de.shj.UP.data.Dozent" /><jsp:useBean id="student" scope="session" class="de.shj.UP.beans.config.student.StudentBean" /><?xml version="1.0" encoding="iso-8859-1"?><%--
    @TODO
    ===========================
    - Unterscheidung 1. HF und 2. HF ist derzeit nur, 
      ob das Fach in SignUp als Fach1 oder Fach2 
      gef?hrt ist.

    - Geburtsland ist nicht bekannt -- lieber "Staat" nennen?

    - Sollte es ein Feld "Universit?t" geben (damit das LLPA verallgemeinern kann?)

    - Anglistik-spezifika auslagern in fragment/conf_... files

    - Sicherheit: Login-Check; besser auch: Matrikelnummer noch
      als Parameter ?bergeben.

    SYNOPSIS (German)
    ===========================
    2014, April 23, shj
    Erzeugt. 
    
    ?hnlich wie export_llpa.csv

    Soll pro Studierender/m Daten zum Staatsexamen nach 
    GymPO liefern (Fachnote, Fachdidaktik, what have you), 
    und zwar in einem Excel-Format.
    
    Expected SESSION PROPERTIES
    ===========================
    user       
    student     

    Expected PARAMETER(S):
    ===========================
    --

    signup-expected-backend-version [text], vgl. fragments/checkVersion.jsp
    
    Returns
    =======
    Object:
    Excel

    Fehler/Errors/THROWS
    ====================

    
--%> 
<?mso-application progid="Excel.Sheet"?>
<Workbook xmlns="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:o="urn:schemas-microsoft-com:office:office"
 xmlns:x="urn:schemas-microsoft-com:office:excel"
 xmlns:ss="urn:schemas-microsoft-com:office:spreadsheet"
 xmlns:html="http://www.w3.org/TR/REC-html40">
 <DocumentProperties xmlns="urn:schemas-microsoft-com:office:office">
  <LastAuthor>Silke Engelhardt</LastAuthor>
  <Created>2014-05-05T10:03:26Z</Created>
  <LastSaved>2014-05-05T08:46:03Z</LastSaved>
  <Version>14.00</Version>
 </DocumentProperties>
 <OfficeDocumentSettings xmlns="urn:schemas-microsoft-com:office:office">
  <AllowPNG/>
 </OfficeDocumentSettings>
 <ExcelWorkbook xmlns="urn:schemas-microsoft-com:office:excel">
  <WindowHeight>10005</WindowHeight>
  <WindowWidth>10005</WindowWidth>
  <WindowTopX>120</WindowTopX>
  <WindowTopY>135</WindowTopY>
  <ActiveSheet>1</ActiveSheet>
  <ProtectStructure>False</ProtectStructure>
  <ProtectWindows>False</ProtectWindows>
 </ExcelWorkbook>
 <Styles>
  <Style ss:ID="Default" ss:Name="Normal">
   <Alignment ss:Vertical="Bottom"/>
   <Borders/>
   <Font ss:FontName="Calibri" x:Family="Swiss" ss:Size="11" ss:Color="#000000"/>
   <Interior/>
   <NumberFormat/>
   <Protection/>
  </Style>
  <Style ss:ID="s63">
   <Alignment ss:Horizontal="Left" ss:Vertical="Top" ss:WrapText="1"/>
   <Borders/>
   <Font ss:FontName="sans-serif" ss:Color="#000000"/>
   <Interior/>
   <NumberFormat/>
   <Protection/>
  </Style>
  <Style ss:ID="s64">
   <Alignment ss:Horizontal="Left" ss:Vertical="Top" ss:WrapText="1"/>
   <Borders/>
   <Font ss:FontName="sans-serif" ss:Color="#000000"/>
   <Interior/>
   <NumberFormat ss:Format="[$-407]dd\.mm\.yyyy"/>
   <Protection/>
  </Style>
 </Styles>
 <Worksheet ss:Name="Sheet1">
  <Table ss:ExpandedColumnCount="89" ss:ExpandedRowCount="2350" x:FullColumns="1"
   x:FullRows="1" ss:DefaultColumnWidth="78.75" ss:DefaultRowHeight="15">
   <Column ss:AutoFitWidth="0" ss:Width="21.75"/>
   <Column ss:Index="3" ss:AutoFitWidth="0" ss:Width="21"/>
   <Column ss:Index="19" ss:AutoFitWidth="0" ss:Width="120.75"/>
   <Row ss:AutoFitHeight="0">
    <Cell ss:StyleID="s63"><Data ss:Type="String">rtyp</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">anrd</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">geschl</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">mtknr</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">nachname</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">vorname</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">gebdat</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">gebort</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">gebland</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">str</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">plz</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">ort</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">tel</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">emailpriv</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_stg</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_stgtext</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_fs</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_lp</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_note</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_fdstat</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_fdlp</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_fdnote</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_zpstat</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_zplp</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">hf1_zpnote</Data></Cell>
   </Row>
<%@include file="../fragments/conf_llpa.jsp" %><%
    // Um welche Studierenden geht es?
    ResultSet rst = user.sqlQuery("select s.* from \"tblBdStudent\" s where \"strStudentZUVFach\" != '' and " + 
            "exists (select \"strMatrikelnummer\" from \"tblBdStudentXLeistung\" x where x.\"strMatrikelnummer\" = s.\"strMatrikelnummer\" and " + 
            "x.\"lngSdSeminarID\"=" + user.getSdSeminarID() + ");");
    
    while(rst.next()){
        student.initByRst(rst);
        student.setSeminarID(user.getSdSeminarID());
    /*
     * Sto?e Berechnung der Fachnote und LP-Summe an:
     */
    Fachnote note=new Fachnote(student.getMatrikelnummer(), user.getSdSeminarID(), student.getFachID(user.getSdSeminarID()));
    
    /**
     * Auslagelagert in fragments/conf:
     * Welche Leistungen geh?ren zur Fachdidaktik?
     * Welche Pr?fungen sind Zwischenpr?fungen?
     *     String sFachdidaktik="(20220,20230)";
     *    String sZP = "(200001)";
     */
    
    Fachdidaktik fd=getFachdidaktik(student, sFachdidaktik);
    String sHFSwitch="";
    
    /**
     * Der Eintrag im Excel-Dokument erfolgt acht Spalten weiter 
     * rechts, wenn das Fach im aktuellen Seminar das 2. Hauptfach ist
     * (dann werden also acht Semikolons eingef?gt).
     * 
     * Ansonsten unterscheiden sich HF1 und HF2 nicht voneinander.
     * Dazu l?uft aber bereits eine R?ckfrage ans Pr?fungsamt.
     */
    if(student.Fach() != null){
        if(student.Fach().getFachID()!=student.getStudentFach1()) sHFSwitch=";;;;;;;;";
    }else{System.out.println("[ERR]: Fach ist NULL bei " + student.getStudentNachname() + " (" + student.getMatrikelnummer() + ")");}
            String sZPNote=getZPNote(student,sZP);
%>   <Row ss:AutoFitHeight="0">
    <Cell ss:StyleID="s63"><Data ss:Type="String"></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentFemale() ? "Frau":"Herr" %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentFemale() ? "W":"M" %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="Number"><%=student.getMatrikelnummer()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentNachname()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentVorname()%></Data></Cell>
    <Cell ss:StyleID="s64"><Data ss:Type="DateTime"><%=student.getStudentGeburtstag()%>T00:00:00.000</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentGeburtsort()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentStaat()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentStrasse()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentPLZ()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentOrt()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentTelefon()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getStudentEmail()%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=g_sFachcodeHIS%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=g_sFachnameHIS %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=student.getFachsemester() %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=String.valueOf(note.getSummeLPErreicht().subtract(new BigDecimal(fd.m_lp)).subtract(new BigDecimal(getEPGLP(student,g_lEPG_LeistungID)))).replace('.',',')%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=getFachnoteHISStyle(note) %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=(fd.m_lp >= g_fMinLP_Fachdidaktik ? "BE" : "") %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=String.valueOf(fd.m_lp).replaceAll("\\.0","") %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=String.valueOf(fd.m_note).replaceAll("\\.0","")%></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=sZPNote.startsWith("#") ? "" : "BE" %></Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String">k.A.</Data></Cell>
    <Cell ss:StyleID="s63"><Data ss:Type="String"><%=sZPNote.startsWith("#") ? "" : getZPNoteHISStyle(sZPNote)%></Data></Cell>
   </Row>
    <%}%>
<%!
String getZPNote(de.shj.UP.beans.config.student.StudentBean st, String sZP_conf){
    long lNumberOfZP=0;
    String sZPNote="";
    try{
        sZPNote=st.lookUp("strStudentPruefungNote", "tblBdStudentXPruefung",
                "\"lngSdSeminarID\"=" + st.getSeminarID() + " and " + 
                 "\"lngSdPruefungsID\" in " + sZP_conf + " and " + 
                 "\"strMatrikelnummer\"='" + st.getMatrikelnummer() + "' and " + 
                  "\"blnStudentPruefungBestanden\"=true");
    }catch(Exception eNotNumeric){}
    return sZPNote;
}
String getZPNoteHISStyle(String sNote){
    String sReturn=sNote;
    try{
        sReturn=String.valueOf(Float.parseFloat(sNote)*100).substring(0,3);
    }catch(Exception eNotNumeric){
      //Ignore
    }
    return sReturn;
}
String getFachnoteHISStyle(Fachnote note){
  String sReturn=String.valueOf(note.getGradeUnrounded());
  sReturn=sReturn.substring(0, Math.min(sReturn.length(), sReturn.indexOf('.')+3));
  sReturn=String.valueOf(Float.parseFloat(sReturn)*100).substring(0,3);
  if(sReturn.indexOf('-')>=0) return "";
  
  if(note.isComplete())
    return String.valueOf(note.getGradeUnrounded().multiply(new BigDecimal(100))).substring(0, 3);
  else{
    try{
        return String.valueOf(note.getPreliminaryGradeUnrounded().multiply(new BigDecimal(100))).substring(0, 3)  +  " (vorl.)";
    }catch(Exception e){
        return String.valueOf(note.getPreliminaryGradeUnrounded()) + " (vorl.)";
    }
  }
  // return sReturn;
}
String getEPGLP(de.shj.UP.beans.config.student.StudentBean st, long lEPGLeistungID) throws Exception{

    ResultSet rEPG = st.sqlQuery("SELECT " +
        "sum(x.\"sngStudentLeistungCreditPts\") summe_epg " +
      "FROM " +
        "\"tblBdStudentXLeistung\" x, " +
        "\"tblSdNote\" n " +
      "WHERE " +
        "n.\"lngSdSeminarID\" = x.\"lngSdSeminarID\" AND " +
        "n.\"intNoteID\" = x.\"intNoteID\" AND " +
        "n.\"blnNoteBestanden\" = true AND " +
        "x.\"strMatrikelnummer\"='" + st.getMatrikelnummer() + "' and " +
        "x.\"lngLeistungsID\" = " + lEPGLeistungID + " and " +
        "x.\"lngSdSeminarID\"=" + st.getSeminarID() + ";");
   if(rEPG.next()){
        return (rEPG.getString("summe_epg")==null ? "0" : rEPG.getString("summe_epg"));
   }else{
        return "0";
   }
   
}
Fachdidaktik getFachdidaktik(de.shj.UP.beans.config.student.StudentBean st, String sFachdidaktik_conf)throws Exception{
    ResultSet rFachdidaktik = st.sqlQuery("SELECT " +
        "n.\"sngNoteECTSCalc\"," +
        "x.\"sngStudentLeistungCreditPts\" " +
      "FROM " +
        "\"tblBdStudentXLeistung\" x, " +
        "\"tblSdNote\" n " +
      "WHERE " +
        "n.\"lngSdSeminarID\" = x.\"lngSdSeminarID\" AND " +
        "n.\"intNoteID\" = x.\"intNoteID\" AND " +
        "n.\"blnNoteBestanden\" = true AND " +
        "x.\"strMatrikelnummer\"='" + st.getMatrikelnummer() + "' and " +
        "x.\"lngLeistungsID\" in " + sFachdidaktik_conf + " and " +
        "x.\"lngSdSeminarID\"=" + st.getSeminarID() + ";");
    
        BigDecimal fModulnote;
        BigDecimal fScalarProduct=new BigDecimal("0");
        BigDecimal fActualDivisor=new BigDecimal("0");
        
        while(rFachdidaktik.next()){
            fScalarProduct=fScalarProduct.add(rFachdidaktik.getBigDecimal("sngNoteECTSCalc").multiply(rFachdidaktik.getBigDecimal("sngStudentLeistungCreditPts")));
            fActualDivisor=fActualDivisor.add(rFachdidaktik.getBigDecimal("sngStudentLeistungCreditPts"));
        }
        
        try{
            fModulnote=fScalarProduct.divide(fActualDivisor);
        }catch(Exception e){
            return new Fachdidaktik(fActualDivisor.doubleValue(),0);
        }
        return new Fachdidaktik(fActualDivisor.doubleValue(),fModulnote.doubleValue()*100);
};

public static class Fachdidaktik{
    double m_lp=0;
    double m_note=0;
    public Fachdidaktik(double lp, double note){
        this.m_lp=lp;
        this.m_note=note;
    }
}
%></Table>
<WorksheetOptions xmlns="urn:schemas-microsoft-com:office:excel">
   <PageSetup>
    <Header x:Margin="0.3"/>
    <Footer x:Margin="0.3"/>
    <PageMargins x:Bottom="0.78740157499999996" x:Left="0.7" x:Right="0.7"
     x:Top="0.78740157499999996"/>
   </PageSetup>
   <Selected/>
   <Panes>
    <Pane>
     <Number>3</Number>
     <ActiveRow>26</ActiveRow>
     <ActiveCol>8</ActiveCol>
    </Pane>
   </Panes>
   <ProtectObjects>False</ProtectObjects>
   <ProtectScenarios>False</ProtectScenarios>
  </WorksheetOptions>
 </Worksheet>
</Workbook>