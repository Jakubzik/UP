$(function(){function e(e,t){$("#modConfirmTausch .titel").html(e.titel);$("#modConfirmTausch .dozent").html(e.dozent_name);$("#modConfirmTausch .titel_neu").html(t.titel);$("#modConfirmTausch .dozent_neu").html(t.dozent_name);$("#cmdKursTauschConfirm").off().on("click",function(){n(e,3,t)});$("#cmdKursTauschCancel").on("click",function(){$("#modConfirmTausch").modal("hide")});$("#modConfirmTausch").modal("show")}function t(e){if(confirm("Wollen Sie "+e.titel+" wirklich löschen?")){var t={};t.kurstyp_id=e.kurstyp_id;t.kurs_id=e.id;$.ajax({data:t,url:"json/student/signup/tausch/delete.jsp",type:"POST",success:function(e){$("#modTauschenOderLoeschen").modal("hide");alert("Danke, dass Sie den Kursplatz freigegeben haben!");a(function(){s()})},error:function(e,t,n){alert("Fehler beim Versuch, einen Kursplatz zurückzugeben")},cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}}function n(r,i,o){if(i<1){$("#cmdKursAnmeldungSwapShowOptions").off().on("click",function(){n(r,1)});$("#cmdKursAnmeldungDelete").off().on("click",function(){t(r)});$("#modTauschenOderLoeschen .kurs_titel").html(r.titel);$("#modTauschenOderLoeschen").modal("show");return}if(i===1){$("#modTauschenOderLoeschen").modal("hide");$("#divKurseTausch").empty();$("#divKurseTausch").removeData();$("#modTauschkursWahl .kurs_titel").html(r.titel);if($("#cboKurstypenKurswahlTausch option").length<=1)shj.signUp.toolbox.populateCbo($.signUpGlobal.kurstypen_kurswahl,{identifyer:"id",text:"name",cboIdentifyer:"#cboKurstypenKurswahlTausch"});$("#cboKurstypenKurswahlTausch").on("click",function(){var t="";var n=$(this).val();var i=$.signUpGlobal.kurstypen.get(n);var s=","+i.kurse.join(",")+",";var o=h(n);$("#divKurseTausch").empty();$("#divKurseTausch").removeData();var u=$("#template_kursListe").clone();var a=new Array;u.removeAttr("id");for(var f=0;f<$.signUpGlobal.kurse.kurse.length;f++){if(s.indexOf(","+$.signUpGlobal.kurse.kurse[f].id+",")>=0&&$.signUpGlobal.kurse.kurse[f].erlaubt_kurswahl=="true"){if($.signUpGlobal.kurse.kurse[f].zuschlag!="true"){var l=u.clone();l.find(".template_kurs_titel").html($.signUpGlobal.kurse.kurse[f].titel);l.find(".template_kurs_termin").html($.signUpGlobal.kurse.kurse[f].termin);l.find(".template_kurs_dozent_name").html($.signUpGlobal.kurse.kurse[f].dozent_name);l.data("shj_item",$.signUpGlobal.kurse.kurse[f]);$("#divKurseTausch").append(l)}}}$("#divKurseTausch").find("dl").on("click",function(){$("#modTauschkursWahl").modal("hide");var t=$(this).data("shj_item");t.kurstyp_id=$("#cboKurstypenKurswahlTausch").val();e(r,t)})});$("#cboKurstypenKurswahlTausch option[value="+r.kurstyp_id+"]").attr("selected","selected");$("#cboKurstypenKurswahlTausch").trigger("click");$("#modTauschkursWahl").modal("show")}if(i==3){var u={};u.kurstyp_id=r.kurstyp_id;u.kurs_id=r.id;u.kurstyp_id_neu=o.kurstyp_id;u.kurs_id_neu=o.id;$.ajax({data:u,url:"json/student/signup/tausch/add.jsp",type:"POST",success:function(e){if(e.success=="true"){$("#modTauschkursWahl").modal("hide");$("#modTauschenOderLoeschen").modal("hide");$("#modConfirmTausch").modal("hide");a(function(){$("#modShj_SignUp_OK").modal("show").delay(1500).queue(function(e){$("#modShj_SignUp_OK").modal("hide");s();e()})})}else{$("#modTauschkursWahl").modal("hide");$("#modTauschenOderLoeschen").modal("hide");$("#modConfirmTausch").modal("hide");$("#modSpeichernERR").modal("show").find(".fehler_msg").text(e.message);a(s)}},error:function(e,t,n){alert("Fehler beim Versuch, einen Kursplatz zu tauschen")},cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}}function r(e){var t=$("#kurstypen_mit_tauschoption").val();var r=$("#kurse_mit_tauschverbot").val();var i=c(e);$("#Kurswahl_Tausch").append("<h4>"+$.signUpGlobal.kurstypen.get(e).name+"</h4>");var s=$("<ul>");var o=0;if(i!==null){for(var u=0;u<i.length;u++){var a=$("#template_kurswahl_liste li").clone();if(i[u].zuschlag!="true"){}else{a.addClass("alert alert-success");o++}var f=i[u];f.kurstyp_id=e;a.find(".shj_titel").html('<a href="#">'+i[u].titel+"</a>");a.find(".shj_kurs_info").text(" ("+i[u].dozent_name+", "+i[u].termin+")");a.data("shj_item",f);a.find("a").on("click",function(){n($(this).parents("li").data("shj_item"),0)});if(i[u].zuschlag=="true")s.append(a)}if(o==0)$("#Kurswahl_Tausch").append("<ul><li>Kein Kurs</li></ul>");else $("#Kurswahl_Tausch").append(s)}else{throw Exception("Fehler beim Sortieren der Anmeldungen")}}function i(e){var t={};t.cmdDeleteVormerkung="yes";t.kurstyp_id=e.kurstyp_wunsch_id;t.kurs_id=e.kurs_wunsch_id;$.ajax({data:t,url:"json/student/signup/tausch/delete.jsp",type:"POST",success:function(e){a(s)},cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}function s(){var e="";var t=$("#kurstypen_mit_tauschoption").val();var n=$("#kurse_mit_tauschverbot").val();$("#Kurswahl_Tausch").empty();for(var s=0;s<$.signUpGlobal.anmeldungen.length;s++){if(t.indexOf(","+$.signUpGlobal.anmeldungen[s].kurstyp_id+",")>=0&&e.indexOf(";"+$.signUpGlobal.anmeldungen[s].kurstyp_id+";")<0){e+=";"+$.signUpGlobal.anmeldungen[s].kurstyp_id+";";r($.signUpGlobal.anmeldungen[s].kurstyp_id)}}var o=$("#template_kurswahl_vormerkungen").clone();var u={};$("#divVormerkungen").empty();for(var s=0;s<$.signUpGlobal.vormerkungen.length;s++){var o=$("#template_kurswahl_vormerkungen").clone();u=$.signUpGlobal.kurse.get($.signUpGlobal.vormerkungen[s].kurs_wunsch_id);o.find(".shj_titel_wunsch").html(u.titel).end().find(".shj_titel").html($.signUpGlobal.kurse.get($.signUpGlobal.vormerkungen[s].kurs_id).titel).end().find(".shj_dozent_name").text(u.dozent_name).end().find("a").data("shj_item",$.signUpGlobal.vormerkungen[s]).on("click",function(){i($(this).data("shj_item"))});$("#divVormerkungen").append(o)}}function o(e){var t=c(e);$("#Kurswahl_Liste").append("<h4>"+$.signUpGlobal.kurstypen.get(e).name+"</h4>");var n=$("#signup-is-result-mode").val();if(n=="true")var r=$("<ul>");else var r=$("<ol>");if(t!==null){for(var i=0;i<t.length;i++){var s=$("#template_kurswahl_liste li").clone();var o=false;if(n=="true"){if(t[i].zuschlag!="true"){s.addClass("muted");o=true}else{s.addClass("alert alert-success")}}if(o){s.find(".shj_titel").html(t[i].titel)}else{s.find(".shj_titel").html('<a href="#">'+t[i].titel+"</a>")}s.find(".shj_kurs_info").text(" ("+t[i].dozent_name+", "+t[i].termin+")");s.data("shj_item",t[i]);s.find("a").on("click",function(){l($(this).parents("li").data("shj_item"))});r.append(s)}$("#Kurswahl_Liste").append(r);$("#Kurswahl_Liste .muted").hide()}else{throw Exception("Fehler beim Sortieren der Anmeldungen")}}function u(){var e="";$("#Kurswahl_Liste").empty();for(var t=0;t<$.signUpGlobal.anmeldungen.length;t++){if(e.indexOf(";"+$.signUpGlobal.anmeldungen[t].kurstyp_id+";")<0){e+=";"+$.signUpGlobal.anmeldungen[t].kurstyp_id+";";o($.signUpGlobal.anmeldungen[t].kurstyp_id)}}}function a(e){$.ajax({url:"json/student/signup/get.jsp",type:"POST",success:function(t){$.signUpGlobal.anmeldungen=t.anmeldungen;$.signUpGlobal.vormerkungen=t.vormerkungen;if(typeof e==="function")e()},error:function(e,t,n){alert("Fehler beim Laden der Anmeldungen: "+t+" "+n)},cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}function f(){if($(".droppable").length!==$(".droppable a").length)return;var e={};e.kurstyp_id=$("#cboKurstypenKurswahl").val();for(var t=1;t<11;t++){if($("#wahlkurs-"+t).length){e["kurs_id_"+t]=$("#wahlkurs-"+t).data("shj_item").id}else{break}}$.ajax({url:"json/student/signup/update.jsp",type:"POST",success:function(e){if(e.success=="true"){$("#modShj_SignUp_OK").modal("show").delay(1500).queue(function(e){$("#modShj_SignUp_OK").modal("hide");$("#divKurseDropped div").removeClass().addClass("well shj_SignUp_clean");e()});a()}else{$("#modSpeichernERR").modal("show").find(".fehler_msg").text(e.message);$("#cboKurstypenKurswahl").trigger("click")}},error:function(e,t,n){alert("Fehler beim Speichern der Anmeldung: "+t+" "+n)},data:e,cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}function l(e){if(typeof e!=="undefined"){$("#modKursDetails").find(".kurs_titel").html(e.titel);$("#modKursDetails").find(".kurs_beschreibung").html(e.beschreibung);$("#modKursDetails").find(".kurs_dozent_name").text(e.dozent_name);$("#modKursDetails").modal("show")}}function c(e){var t=new Array;for(var n=0;n<$.signUpGlobal.anmeldungen.length;n++){if($.signUpGlobal.anmeldungen[n].kurstyp_id==e){var r=$.signUpGlobal.kurse.get($.signUpGlobal.anmeldungen[n].kurs_id);r.zuschlag=$.signUpGlobal.anmeldungen[n].zuschlag;t.push(r)}}t.sort(function(e,t){return t.prioritaet-e.prioritaet});for(var n=0;n<t.length;n++)t[n].prio_normal=n+1;return t}function h(e){var t=new Array;for(var n=0;n<$.signUpGlobal.anmeldungen.length;n++){if($.signUpGlobal.anmeldungen[n].kurstyp_id==e)t.push($.signUpGlobal.anmeldungen[n].kurs_id)}return","+t.join(",")+","}function p(){$("#divKurse").find("dl").on("click",function(){l($(this).data("shj_item"))});$("#divKurseDropped").find("div").on("click",function(){l($(this).data("shj_item"))})}function d(e){$("#divKurse").addClass("muted").delay(100).queue(function(e){$("#divKurse").removeClass("muted");e()});var t=$("#"+e).data("shj_item");var n=$("#template_kursListe").clone();n.removeAttr("id");n.find(".template_kurs_titel").html(t.titel);n.find(".template_kurs_termin").html(t.termin);n.find(".template_kurs_dozent_name").html(t.dozent_name);n.data("shj_item",t);$("#divKurse").prepend(n).find(".draggable").draggable({revert:"invalid"});$("#"+e).text(e.substring(e.length-1)+". Wahl").removeClass().removeData().addClass("well muted droppable").droppable({accept:function(){return typeof $(this).data("shj_item")==="undefined"},activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(e,t){$(this).addClass("ui-state-highlight").data("shj_item",t.draggable.data("shj_item")).text(t.draggable.data("shj_item").titel).prepend('<a class="pull-right label label-important" title="Kurs aus Auswahl löschen"><i class="icon-remove"></i> </a>');t.draggable.hide();var n=$(this).attr("id");$(this).find("a").on("click",function(){d(n)})}});if($("#divKurseDropped a").length===0){var r={};r.kurstyp_id=$("#cboKurstypenKurswahl").val();$.ajax({url:"json/student/signup/delete.jsp",type:"POST",success:function(e){$("#modShj_SignUp_OK").modal("show").delay(1500).queue(function(e){$("#modShj_SignUp_OK").modal("hide");e()});a()},error:function(e,t,n){alert("Fehler beim Löschen der Anmeldung: "+t+" "+n)},data:r,cache:false,timeout:2e4,contentType:"application/x-www-form-urlencoded;charset=utf8",dataType:"json"})}else{$("#divKurseDropped .shj_SignUp_clean").removeClass("shj_SignUp_clean").addClass("shj_SignUp_dirty");p()}return true}function v(){$.signUpGlobal.kurstypen=new shj.signUp.seminar.Kurstypen($.signUpGlobal.seminar_id,function(e){$.signUpGlobal.kurstypen_kurswahl=new Array;for(var t=0;t<e.kurstypen.length;t++){if(e.kurstypen[t].kurswahl==="true"&&m(e.kurstypen[t].leistung_id))$.signUpGlobal.kurstypen_kurswahl.push(e.kurstypen[t])}shj.signUp.toolbox.populateCbo($.signUpGlobal.kurstypen_kurswahl,{identifyer:"id",text:"name",cboIdentifyer:"#cboKurstypenKurswahl"})})}function m(e){if($.signUpGlobal.info.seminar.mein_fach==null){$.signUpGlobal.info.seminar.mein_fach=$.signUpGlobal.info.seminar.faecher.get($.signUpGlobal.student_fach_id);$.signUpGlobal.info.seminar.meine_leistungen="";for(var t=0;t<$.signUpGlobal.info.seminar.mein_fach.module.length;t++){for(var n=0;n<$.signUpGlobal.info.seminar.mein_fach.module[t].modul.leistungen.length;n++){$.signUpGlobal.info.seminar.meine_leistungen+=";"+$.signUpGlobal.info.seminar.mein_fach.module[t].modul.leistungen[n].leistung.id+";"}}}return $.signUpGlobal.info.seminar.meine_leistungen.indexOf(";"+e+";")>=0}$("#cmdShowTausch").on("click",function(){s()});$("#cboKurstypenKurswahl").on("click",function(){$("#divKurse").empty();$("#divKurseDropped").empty();$(".shj_showOnKurswahl").fadeIn();$(".shj_hideOnKurswahl").hide();var e="";var t=$("#cboKurstypenKurswahl").val();var n=$.signUpGlobal.kurstypen.get(t);var r=","+n.kurse.join(",")+",";var i=h(t);var s=$("#template_kursListe").clone();var o=new Array;s.removeAttr("id");for(var u=0;u<$.signUpGlobal.kurse.kurse.length;u++){if(r.indexOf(","+$.signUpGlobal.kurse.kurse[u].id+",")>=0&&$.signUpGlobal.kurse.kurse[u].erlaubt_kurswahl=="true"){if(i.indexOf(","+$.signUpGlobal.kurse.kurse[u].id+",")<0){var a=s.clone();a.find(".template_kurs_titel").html($.signUpGlobal.kurse.kurse[u].titel);a.find(".template_kurs_termin").html($.signUpGlobal.kurse.kurse[u].termin);a.find(".template_kurs_dozent_name").html($.signUpGlobal.kurse.kurse[u].dozent_name);a.data("shj_item",$.signUpGlobal.kurse.kurse[u]);$("#divKurse").append(a).find(".draggable").draggable({revert:"invalid"})}}}var l=null;if(i.length>2){l=c(t)}var v="";for(var m=0;m<n.kurswahl_anzahl;m++){v+='<div class="well muted droppable" id="wahlkurs-'+(m+1)+'">'+(m+1)+". Wahl</div>"}$("#divKurseDropped").append(v).find(".droppable").droppable({accept:function(){return typeof $(this).data("shj_item")==="undefined"},activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(e,t){$(this).addClass("ui-state-highlight").data("shj_item",t.draggable.data("shj_item")).text(t.draggable.data("shj_item").titel).prepend('<a class="pull-right label label-important" title="Kurs aus Auswahl löschen"><i class="icon-remove"></i> </a>');t.draggable.hide();var n=$(this).attr("id");$(this).find("a").on("click",function(){d(n)});f()}});if(l!==null){for(var u=0;u<l.length;u++){var g="wahlkurs-"+l[u].prio_normal;$("#"+g).data("shj_item",l[u]).text(l[u].titel).prepend('<a class="pull-right label label-important"><i class="icon-remove"></i> </a>').removeClass("muted").addClass("shj_SignUp_clean");$("#"+g).find("a").on("click",function(){d($(this).parents("div").attr("id"))})}}p()});$("#cmdShowErgebnis").on("click",function(){u()});$(".draggable").draggable({revert:"invalid"});$(".droppable").droppable({activeClass:"ui-state-hover",hoverClass:"ui-state-active",drop:function(e,t){$(this).addClass("ui-state-highlight").text(t.draggable.text());t.draggable.hide()}});$.signUpGlobal.kurse=new shj.signUp.seminar.Kurse($.signUpGlobal.seminar_id,function(e){});a();$.signUpGlobal.matrikelnummer=$("#logged-in-user-matrikelnummer").val();$.signUpGlobal.seminar_id=$("#logged-in-user-seminar").val();$.signUpGlobal.student_fach_id=$("#logged-in-user-fach_id").val();$.signUpGlobal.info={};$.signUpGlobal.info.seminar={};$.signUpGlobal.info.seminar.mein_fach=null;$.signUpGlobal.info.seminar.faecher=new shj.signUp.seminar.Faecher($.signUpGlobal.seminar_id,function(){v()});if($("#signup-is-result-mode").val()=="true")$("#tab1").html("<h2>Kurswahl zur Zeit nicht möglich</h2>")})